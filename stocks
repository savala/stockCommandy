#!/usr/bin/env bash
# Built by Sai Avala

get() {
    if [ -z "$2" ]
        then
            printf "No stock tickers passed.\n"
            return
    fi
    url="http://download.finance.yahoo.com/d/quotes.csv?s=$2&f=l1"
    price="$(curl -s "$url")"
    ticker="$(printf "%s" "$2" | awk '{print toupper($0)}')"
    printf "%s\tprice: %s\n" "$ticker" "$price"
}

add() {
    if [ ! -d ~/.stocks ];then
        mkdir ~/.stocks
    fi
    stock="$(printf "%s" "$1" | awk '{print toupper($0)}')"
    printf "%s\n" "$stock" >> ~/.stocks/stocksList.txt
    printf "Added %s to list of stocks.\n" "$stock"
}

delete() {
    stock="$(echo "$1" | awk '{print toupper($0)}')"
    printf "%s" "$stock" | awk "!/$stock/" ~/.stocks/stocksList.txt > temp && mv temp ~/.stocks/stocksList.txt
}

clean() {
    rm ~/.stocks/stocksList.txt
    rmdir ~/.stocks
}

help() {
    printf "-add <ticker>, ie. -add xyz \n-clean\n-get xyz\n"
}

list() {
    cat ~/.stocks/stocksList.txt
}

openStockPage() {
    url="https://finance.yahoo.com/q?s=$1"
    open "$url"
}

if [ -z "$1" ];then
    if [ ! -f ~/.stocks/stocksList.txt ];then
        printf "You must add a stock (i.e. stocks -add xyz)\n"
    else
        stocks=""
        while read -r line
        do
            stocks+="$line,"
        done < ~/.stocks/stocksList.txt
        # url="http://download.finance.yahoo.com/d/quotes.csv?s=$stocks&f=p"
        url="http://download.finance.yahoo.com/d/quotes.csv?s=$stocks&f=l1a"
        prices="$(curl -s "$url")"
        prices=(${prices//\n/ })
        stocks=(${stocks//,/ })
        for key in "${!stocks[@]}"; do
            stock="$(echo "${stocks[$key]}" | awk '{print toupper($0)}')"
            p="${prices[$key]}"
            x=(${p//,/ })
            #echo "$stock\tPrice: ${x[0]}\tSomething: ${x[1]}";
            printf "%s\tPrice: %s\n" "${stock}" "${x[0]}"
        done
    fi
else
    case $1 in
        "-add" )
            add "$2";;
        "-get" )
            get "$1" "$2";;
        "-clean" )
            clean;;
        "-rm" )
            printf "Removed %s\n" "${2}"
            delete "$2";;
        "-list" )
            list;;
        "-help" )
            help;;
    esac
fi
